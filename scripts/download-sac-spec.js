#!/usr/bin/env node

import https from "https";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

// Get __dirname equivalent in ESM
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Get repo root
const REPO_ROOT = path.join(__dirname, "..");

// URLs and paths
const REPO_URL =
  "https://raw.githubusercontent.com/stellar/stellar-asset-contract-spec/main/stellar-asset-spec.xdr";
const TS_FILE = path.join(REPO_ROOT, "src/bindings/sac-spec.ts");

console.log("Downloading Stellar Asset Contract spec from GitHub...");

// Download file
https
  .get(REPO_URL, (response) => {
    if (response.statusCode !== 200) {
      console.error(`✗ Failed to download: HTTP ${response.statusCode}`);
      process.exit(1);
    }

    const chunks = [];

    response.on("data", (chunk) => {
      chunks.push(chunk);
    });

    response.on("end", () => {
      const buffer = Buffer.concat(chunks);

      // Verify file has content
      if (buffer.length === 0) {
        console.error("✗ Downloaded file is empty");
        process.exit(1);
      }

      console.log("✓ Successfully downloaded file");
      console.log(`  Size: ${buffer.length} bytes`);

      // Convert to base64
      console.log("Converting to base64...");
      const base64Content = buffer.toString("base64");

      if (!base64Content) {
        console.error("✗ Base64 conversion failed");
        process.exit(1);
      }

      // Update TypeScript file
      console.log(`Updating ${path.relative(REPO_ROOT, TS_FILE)}...`);
      const tsContent = [
        "// Auto-generated by scripts/download-sac-spec.sh",
        "// Do not edit manually - run the script to update",
        `export const SAC_SPEC = "${base64Content}";`,
        "", // trailing newline
      ].join("\n");

      try {
        fs.writeFileSync(TS_FILE, tsContent, "utf8");
        console.log(
          `✓ Successfully updated ${path.relative(REPO_ROOT, TS_FILE)}`,
        );
      } catch (error) {
        console.error(`✗ Failed to write file: ${error.message}`);
        process.exit(1);
      }

      console.log("✓ Done");
    });
  })
  .on("error", (error) => {
    console.error(`✗ Error: ${error.message}`);
    process.exit(1);
  });
